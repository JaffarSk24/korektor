<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <title>Korektor slovenƒçiny | Oprava slovenƒçiny | Editor</title>
  <meta name="description" content="Korektor slovenƒçiny V√°m prin√°≈°a spoloƒçnos≈• White Eagles & Co. s.r.o.">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <style>
    :root{
      --primary:#4c536d;
      --accent:#ff500c;
      --ok:#4c536d;
      --border:#d0d8e0;
      --warn-bg:rgba(255,80,12,0.08);
      --warn-border:rgba(255,80,12,0.25);
    }
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f7f8fa;color:var(--primary);margin:18px}
    h1{font-size:20px;margin:0 0 10px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:stretch;width:100%}
    .card{background:#fff;padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
    textarea{width:100%;height:100%;min-height:15rem;padding:14px;padding-right:42px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;resize:vertical;line-height:1.5;font-size:15px;box-sizing:border-box}
    textarea:focus{outline:2px solid var(--border)}
    .output{width:100%;height:100%;min-height:15rem;padding:14px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;overflow:auto;position:relative;box-sizing:border-box}
    .output:focus-within{outline:2px solid var(--border)}
    .error-underline{background-color:rgba(255,80,12,0.25);border-radius:3px;cursor:pointer;padding:1px 2px}
    .word-replaced{background-color:rgba(76,83,109,0.06)}
    .btn-accent{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:999px;cursor:pointer}
    .apply-used{background:#ccc !important;color:#666 !important;cursor:not-allowed}
    .fade-out{animation:fadeOutUp .32s ease forwards}
    @keyframes fadeOutUp{from{opacity:1}to{opacity:0;transform:translateY(-10px)}}
    .suggest-menu{position:absolute;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.12);z-index:999;display:none;overflow:hidden}
    .suggest-option{padding:8px 12px;cursor:pointer;white-space:nowrap}
    .suggest-option:hover{background:rgba(255,80,12,0.06)}
    .copy-btn{position:absolute;top:10px;right:10px;background:transparent;border:0;padding:6px;border-radius:6px;color:#6b7280;cursor:pointer;z-index:50}
    .copy-btn:hover{background:rgba(255,80,12,0.06);color:var(--accent)}
    .copy-toast{position:absolute;right:10px;bottom:100%;margin-bottom:6px;background:var(--primary);color:#fff;padding:6px 10px;border-radius:8px;font-size:13px;opacity:0;transform:translateY(-6px);transition:opacity .18s,transform .18s;pointer-events:none;z-index:60}
    .copy-toast.show{opacity:1;transform:none}
    .errors-list{display:flex;flex-direction:column;gap:12px}
    .status-box{margin-top:12px;padding:12px 14px;background:#ffffff;border:1px solid #e5e7eb;border-left:5px solid var(--ok);border-radius:10px;color:var(--primary);box-shadow:0 6px 18px rgba(0,0,0,0.04);display:flex;align-items:center;gap:10px}
    .status-icon{width:18px;height:18px;display:inline-block;border-radius:50%;border:2px solid var(--ok);position:relative;flex:0 0 18px}
    .status-icon::after{content:"";position:absolute;left:3px;top:4px;width:8px;height:4px;border-left:2px solid var(--ok);border-bottom:2px solid var(--ok);transform:rotate(-45deg)}
    .warn-box{margin-top:12px;padding:12px 14px;background:var(--warn-bg);border:1px solid var(--warn-border);border-radius:10px;color:#5a2d00;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .warn-box strong{font-weight:600}
    .btn-fixall{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
  </style>
</head>
<body>
  <h1>üîé Korektor slovenƒçiny V√°m prin√°≈°a spoloƒçnos≈• White Eagles & Co. s.r.o.</h1>
  <p class="meta" id="placeholderText">V√°≈° text na opravu:</p>

  <div class="grid">
    <div style="position:relative">
      <textarea id="inputText" placeholder="Sem nap√≠≈°te text."></textarea>
      <button id="copyBtn" class="copy-btn" title="Skop√≠rova≈• text" aria-label="Skop√≠rova≈•">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="5" y="6" width="11" height="13" rx="2" stroke="currentColor" stroke-width="1.4"/>
          <rect x="8" y="4" width="11" height="13" rx="2" stroke="currentColor" stroke-width="1.4"/>
        </svg>
      </button>
      <div id="copyToast" class="copy-toast">Skop√≠rovan√©</div>
    </div>
    <div class="output" id="outputText" aria-live="polite"></div>
  </div>

  <h2 style="margin-top:18px">N√°jden√© probl√©my</h2>
  <div id="errorCountBox" class="warn-box" style="display:none">
    <span><strong>Celkov√Ω poƒçet ch√Ωb v texte:</strong> <span id="errorCount">0</span></span>
    <button id="fixAllBtn" class="btn-fixall">Opravi≈• v≈°etko</button>
  </div>
  <div id="autoPunctBox" class="status-box" style="display:none; margin-bottom:12px">
    <span class="status-icon" aria-hidden="true"></span>
    <span><strong>Automatick√° oprava interpunkcie:</strong> Text bol automaticky opraven√Ω (pridan√© ƒçiarky, bodky, atƒè.).</span>
  </div>
  <div id="errors" class="errors-list"></div>
  <div id="noIssues" class="status-box" style="display:none">
    <span class="status-icon" aria-hidden="true"></span>
    <span>V texte sa nena≈°li ≈æiadne probl√©my.</span>
  </div>
  <div id="suggestMenu" class="suggest-menu"></div>

<script>
const API="/api";
const inputEl=document.getElementById('inputText');
const placeholderText=document.getElementById('placeholderText');
const outputEl=document.getElementById('outputText');
const errorsContainer=document.getElementById('errors');
const noIssuesBox=document.getElementById('noIssues');
const autoPunctBox=document.getElementById('autoPunctBox');
const errorCountBox=document.getElementById('errorCountBox');
const errorCountSpan=document.getElementById('errorCount');
const fixAllBtn=document.getElementById('fixAllBtn');
const menu=document.getElementById('suggestMenu');
const copyBtn=document.getElementById('copyBtn');
const copyToast=document.getElementById('copyToast');
let correctedText='';
let punctTriggered=false;

const escapeHtml=s=>(s||'').replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c]));

function buildSuggestionHTML(match) {
  const replacements = (match.replacements || [])
    .map(r => r ? (typeof r === 'string' ? r : (r.value || '')) : '')
    .filter(s => s && s.trim());

  const suggestion = replacements.length ? replacements[0] : "";
  const message = suggestion
    ? `Mo≈æno ch√Ωba diakritika: mysleli ste '${suggestion}'?`
    : "Navrhnut√© opravy";

  const examples = Array.isArray(match.examples) ? match.examples : [];
  const examplesHtml = examples.map(ex =>
    `<div class="example-item" style="margin-top:6px;font-size:13px;color:#6b7280">${escapeHtml(ex)}</div>`
  ).join("");

  return `
    <div style="margin-top:6px;color:#6b7280;font-size:13px">
      ${escapeHtml(message)}
    </div>
    ${examplesHtml ? `<div class="examples-container" style="margin-top:8px">${examplesHtml}</div>` : ""}
  `;
}

function debounce(fn,wait){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),wait);} }

function renderFromApiText(text,matches,orig){
  matches=(matches||[]).sort((a,b)=>a.offset-b.offset);
  if(text!==(orig??text)){punctTriggered=true;}
  autoPunctBox.style.display=punctTriggered?'flex':'none';

  // ‚úÖ —Å—á–∏—Ç–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ –ø–æ –∫–ª—é—á—É
  const seenKeys = {};
  matches.forEach(m=>{
    const wrong=text.slice(m.offset,m.offset+m.length);
    const key = wrong.toLowerCase() + '|' + m.offset;
    seenKeys[key] = true;
  });
  const uniqueCount = Object.keys(seenKeys).length;
  errorCountSpan.textContent = uniqueCount;
  errorCountBox.style.display=uniqueCount?'flex':'none';

  let html='',pos=0;
  matches.forEach((m,i)=>{
    if(m.offset<pos)return;
    html+=escapeHtml(text.slice(pos,m.offset));
    const wrong=text.slice(m.offset,m.offset+m.length);
    const sugg=(m.replacements||[])
      .map(r=> (r ? (typeof r==='string'?r:(r.value||'')) : ''))
      .filter(s=>s&&s.trim())
      .join('|');
    html+=`<span id="err-${i}" class="error-underline" data-suggest="${escapeHtml(sugg)}" data-offset="${m.offset}" data-length="${m.length}" data-key="${escapeHtml((wrong.toLowerCase()+'|'+m.offset))}">${escapeHtml(wrong)}</span>`;
    pos=m.offset+m.length;
  });
  html+=escapeHtml(text.slice(pos));
  outputEl.innerHTML=html;
  errorsContainer.innerHTML='';
  if(matches.length){
    errorsContainer.style.display = 'flex';
    const seen={};
    matches.forEach(m=>{
      const wrong=text.slice(m.offset,m.offset+m.length);
      const key=(wrong.toLowerCase()+'|'+m.offset);
      if(!seen[key]){
        const rep=(m.replacements||[])
          .map(r=> (r ? (typeof r==='string'?r:(r.value||'')) : ''))
          .filter(s=>s&&s.trim())[0] || '';
        const card=document.createElement('div');card.className='card';card.dataset.key=key;
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>${escapeHtml(wrong)} ${rep?`‚Üí ${escapeHtml(rep)}`:''}</strong>
            ${rep?'<button class="apply btn-accent">Pou≈æi≈•</button>':''}
          </div>
          ${buildSuggestionHTML(m)}
        `;
        errorsContainer.appendChild(card);
        seen[key]=true;
      }
    });
    noIssuesBox.style.display='none';
  } else {
    errorsContainer.style.display='none';
    autoPunctBox.style.display='none';
    punctTriggered=false;
    noIssuesBox.style.display='flex';
    errorCountSpan.textContent=0;
  }
  correctedText=getPlain();
  bindErrorSpans();bindApplyButtons();
}
function getPlain(){let t='';outputEl.childNodes.forEach(n=>t+=n.textContent);return t;}
function applyReplacement(offset,len,repl,spanEl){
  const before=correctedText.slice(0,offset),after=correctedText.slice(+offset+ +len);
  inputEl.value=before+repl+after;
  if(spanEl){spanEl.textContent=repl;spanEl.classList.remove('error-underline');spanEl.classList.add('word-replaced');}
  menu.style.display='none';
  const key=spanEl?spanEl.dataset.key:null;
  if(key){const card=errorsContainer.querySelector(`[data-key="${key}"]`);if(card){card.classList.add('fade-out');setTimeout(()=>card.remove(),300);}}
  checkNow();
}
function bindErrorSpans(){outputEl.querySelectorAll('.error-underline').forEach(span=>{
  if(span._bound)return;span._bound=true;
  span.onclick=e=>{
    e.stopPropagation();
    const opts=(span.dataset.suggest||'').split('|').filter(Boolean);if(!opts.length)return;
    menu.innerHTML='';opts.forEach(o=>{
      const it=document.createElement('div');it.className='suggest-option';it.textContent=o;
      it.onclick=()=>applyReplacement(+span.dataset.offset,+span.dataset.length,o,span);
      menu.appendChild(it);
    });
    const r=span.getBoundingClientRect();
    menu.style.left=(r.left+window.scrollX)+'px';menu.style.top=(r.bottom+window.scrollY+4)+'px';menu.style.display='block';
  };
});}
function bindApplyButtons(){errorsContainer.querySelectorAll('.apply').forEach(btn=>{
  if(btn._bound)return;btn._bound=true;
  btn.onclick=()=>{
    const key=btn.closest('[data-key]').dataset.key;
    const span=outputEl.querySelector(`.error-underline[data-key="${key}"]`);
    if(span){
      const sug=(span.dataset.suggest||'').split('|')[0]||span.textContent;
      applyReplacement(+span.dataset.offset,+span.dataset.length,sug,span);
      btn.classList.add('apply-used');btn.textContent='Pou≈æit√©';btn.disabled=true;
    }
  };
});}
fixAllBtn.onclick = () => {
  const spans = Array.from(outputEl.querySelectorAll('.error-underline'));
  if (!spans.length) return;
  let newText = correctedText;
  spans
    .map(span => ({
      offset: +span.dataset.offset,
      length: +span.dataset.length,
      replacement: (span.dataset.suggest || '').split('|')[0] || span.textContent
    }))
    .sort((a, b) => b.offset - a.offset)
    .forEach(m => {
      newText =
        newText.slice(0, m.offset) +
        m.replacement +
        newText.slice(m.offset + m.length);
    });
  inputEl.value = newText;
  checkNow();
};
copyBtn.onclick=()=>{
  navigator.clipboard.writeText(inputEl.value||'').then(()=>{
    copyToast.classList.add('show');setTimeout(()=>copyToast.classList.remove('show'),1500);
  });
};
document.addEventListener('click',e=>{if(!e.target.closest('.error-underline')&&!e.target.closest('.suggest-menu'))menu.style.display='none';});
async function checkNow(){
  const text=inputEl.value||'';
  if(!text.trim()){outputEl.innerHTML='';errorsContainer.innerHTML='';errorCountBox.style.display='none';autoPunctBox.style.display='none';punctTriggered=false;noIssuesBox.style.display='flex';placeholderText.style.display='block';return;}
  placeholderText.style.display='none';
  try{
    const r=await fetch(`${API}/check`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text,language:'sk-SK',level:'picky'})});
    if(!r.ok)throw Error(r.status);const d=await r.json();
    renderFromApiText(d.text||text,d.matches||[],text);}catch(e){console.error(e);}
}
inputEl.addEventListener('input',debounce(checkNow,600));
</script>
</body>
</html>